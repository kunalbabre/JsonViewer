<!DOCTYPE html>
<html>
<head>
    <title>JSON Viewer Panel - Standalone Test</title>
    <link rel="stylesheet" href="/src/styles.css">
    <link rel="stylesheet" href="/src/devtools/panel.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }
        .test-controls {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #333;
            color: white;
            padding: 8px 12px;
            display: flex;
            gap: 8px;
            align-items: center;
            z-index: 1000;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 13px;
        }
        .test-controls button {
            background: #7C3AED;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .test-controls button:hover {
            background: #6D28D9;
        }
        .test-controls .status {
            margin-left: auto;
            font-size: 11px;
            opacity: 0.8;
        }
        .jv-devtools-container {
            margin-top: 40px;
            height: calc(100vh - 40px);
        }
    </style>
</head>
<body class="dark-theme">
    <div class="test-controls">
        <span><strong>Panel Test</strong></span>
        <button onclick="simulateGetUsers()">Simulate GET /users</button>
        <button onclick="simulateGetPosts()">Simulate GET /posts</button>
        <button onclick="simulatePostRequest()">Simulate POST</button>
        <button onclick="simulateAllRequests()">Simulate All</button>
        <button onclick="clearPanel()">Clear</button>
        <span class="status" id="status">Ready</span>
    </div>

    <div class="jv-devtools-container">
        <div class="jv-devtools-sidebar">
            <div class="jv-devtools-header">
                <div class="jv-header-top">
                    <span>JSON Requests</span>
                    <div style="display: flex; gap: 4px;">
                        <button id="manual-btn" class="jv-icon-btn" title="Paste/Enter JSON manually">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                        </button>
                        <button id="clear-btn" class="jv-icon-btn" title="Clear list">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                        </button>
                    </div>
                </div>
                <div style="display: flex; gap: 6px; align-items: center;">
                    <input type="text" id="request-search" class="jv-request-search" placeholder="Filter..." style="flex: 1;">
                    <label title="Show only JSON responses" style="display: flex; align-items: center; font-size: 11px; cursor: pointer; user-select: none; white-space: nowrap; color: var(--text-color);">
                        <input type="checkbox" id="json-only-filter" style="margin: 0 4px 0 0;"> JSON
                    </label>
                </div>
            </div>
            <div id="request-list" class="jv-request-list"></div>
        </div>
        <div id="viewer-root" class="jv-devtools-main">
            <div class="jv-placeholder">
                <div style="text-align: center;">
                    <p>Select a JSON request to view</p>
                    <p style="font-size: 0.8em; opacity: 0.7;">Monitoring network traffic...</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { Viewer } from '/src/ui/Viewer.js';

        let currentViewer = null;
        let lastSelectedView = null;
        let requestId = 0;

        // Mock chrome.runtime
        window.chrome = {
            runtime: {
                lastError: null,
                onMessage: {
                    addListener: () => {}
                }
            },
            devtools: {
                inspectedWindow: { tabId: 1 },
                panels: { themeName: 'dark' }
            }
        };

        // Setup handlers
        setupClearButton();
        setupManualButton();
        setupSearch();

        function setupSearch() {
            const searchInput = document.getElementById('request-search');
            const jsonFilter = document.getElementById('json-only-filter');

            const filterRequests = () => {
                const query = searchInput ? searchInput.value.toLowerCase() : '';
                const jsonOnly = jsonFilter ? jsonFilter.checked : false;

                const items = document.querySelectorAll('.jv-request-item');

                items.forEach(item => {
                    const method = item.querySelector('.jv-request-method').textContent.toLowerCase();
                    const url = item.querySelector('.jv-request-url').title.toLowerCase();
                    const name = item.querySelector('.jv-request-url').textContent.toLowerCase();
                    const status = item.querySelector('.jv-request-status').textContent.toLowerCase();
                    const isJson = item.dataset.isJson === 'true';

                    const matchesText = !query || method.includes(query) || url.includes(query) || name.includes(query) || status.includes(query);
                    const matchesType = !jsonOnly || isJson;

                    if (matchesText && matchesType) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            };

            if (searchInput) searchInput.addEventListener('input', filterRequests);
            if (jsonFilter) jsonFilter.addEventListener('change', filterRequests);
        }

        function setupClearButton() {
            const btn = document.getElementById('clear-btn');
            if (btn) {
                btn.onclick = clearList;
            }
        }

        function setupManualButton() {
            const btn = document.getElementById('manual-btn');
            if (btn) {
                btn.onclick = () => {
                    document.querySelectorAll('.jv-request-item').forEach(i => i.classList.remove('active'));

                    const root = document.getElementById('viewer-root');
                    root.innerHTML = '';

                    currentViewer = new Viewer(root, null, "", { isInvalid: true });

                    setTimeout(() => {
                        const textarea = root.querySelector('textarea');
                        if (textarea) textarea.focus();
                    }, 100);
                };
            }
        }

        function clearList() {
            const list = document.getElementById('request-list');
            if (list) list.innerHTML = '';

            const root = document.getElementById('viewer-root');
            if (root) {
                root.innerHTML = `
                    <div class="jv-placeholder">
                        <div style="text-align: center;">
                            <p>Select a JSON request to view</p>
                            <p style="font-size: 0.8em; opacity: 0.7;">Monitoring network traffic...</p>
                        </div>
                    </div>
                `;
            }
            currentViewer = null;
        }

        function addRequestToList(request, content) {
            const list = document.getElementById('request-list');
            const item = document.createElement('div');
            item.className = 'jv-request-item';

            let url;
            try {
                url = new URL(request.request.url);
            } catch (e) {
                url = { pathname: request.request.url, hostname: '' };
            }

            const name = url.pathname.split('/').pop() || url.hostname || 'Request';

            const mimeType = (request.response.content.mimeType || '').toLowerCase();
            let isJson = mimeType.includes('json');

            if (!isJson && content) {
                const trimmed = content.trim();
                if (trimmed.startsWith('{') || trimmed.startsWith('[')) {
                    isJson = true;
                }
            }

            item.dataset.isJson = isJson;

            item.innerHTML = `
                <div style="display:flex;align-items:center;">
                    <span class="jv-request-method">${request.request.method}</span>
                    <span class="jv-request-url" title="${request.request.url}">${name}</span>
                </div>
                <div class="jv-request-status">${request.response.status} ${request.response.statusText}</div>
            `;

            item.onclick = () => {
                console.log('[Test] Request item clicked');
                document.querySelectorAll('.jv-request-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');

                const root = document.getElementById('viewer-root');
                root.innerHTML = '<div class="jv-placeholder">Loading...</div>';

                try {
                    const json = JSON.parse(content.trim());
                    console.log('[Test] Parsed JSON, calling renderViewer', json);
                    renderViewer(json, content);
                } catch (e) {
                    console.log('[Test] Parse failed, rendering as invalid', e.message);
                    renderViewer(null, content, { isInvalid: true });
                }
            };

            list.appendChild(item);
        }

        function renderViewer(json, rawData, options = {}) {
            console.log('[Test] renderViewer called', { json: typeof json, rawData: typeof rawData, options });
            const root = document.getElementById('viewer-root');
            root.innerHTML = '';

            const viewerOptions = {
                ...options,
                initialView: lastSelectedView || options.initialView,
                onViewChange: (view) => {
                    lastSelectedView = view;
                }
            };

            try {
                currentViewer = new Viewer(root, json, rawData, viewerOptions);
                console.log('[Test] Viewer created successfully');
            } catch (e) {
                console.error('[Test] Error creating Viewer:', e);
                root.innerHTML = `<div style="color:red;padding:20px;">Error: ${e.message}</div>`;
            }
        }

        // Expose functions for test controls
        window.simulateRequest = function(method, url, content, status = 200, statusText = 'OK') {
            const request = {
                request: { method, url },
                response: {
                    status,
                    statusText,
                    content: { mimeType: 'application/json' }
                }
            };
            addRequestToList(request, content);
            updateStatus(`Added ${method} ${url.split('/').pop()}`);
        };

        window.simulateGetUsers = function() {
            const users = [
                { id: 1, name: 'John Doe', email: 'john@example.com', age: 30 },
                { id: 2, name: 'Jane Smith', email: 'jane@example.com', age: 25 },
                { id: 3, name: 'Bob Wilson', email: 'bob@example.com', age: 35 }
            ];
            window.simulateRequest('GET', 'https://api.example.com/users', JSON.stringify(users, null, 2));
        };

        window.simulateGetPosts = function() {
            const posts = [
                { id: 1, title: 'First Post', body: 'This is the first post content', userId: 1 },
                { id: 2, title: 'Second Post', body: 'This is the second post content', userId: 2 }
            ];
            window.simulateRequest('GET', 'https://api.example.com/posts', JSON.stringify(posts, null, 2));
        };

        window.simulatePostRequest = function() {
            const response = { id: 101, title: 'New Post', body: 'Created!', userId: 1 };
            window.simulateRequest('POST', 'https://api.example.com/posts', JSON.stringify(response, null, 2), 201, 'Created');
        };

        window.simulateAllRequests = function() {
            window.simulateGetUsers();
            setTimeout(() => window.simulateGetPosts(), 100);
            setTimeout(() => window.simulatePostRequest(), 200);
            setTimeout(() => {
                window.simulateRequest('PUT', 'https://api.example.com/posts/1', JSON.stringify({ id: 1, title: 'Updated', updated: true }));
            }, 300);
            setTimeout(() => {
                window.simulateRequest('DELETE', 'https://api.example.com/posts/1', JSON.stringify({ success: true }));
            }, 400);
        };

        window.clearPanel = clearList;

        function updateStatus(msg) {
            document.getElementById('status').textContent = msg;
        }

        // Auto-simulate for testing
        if (window.location.search.includes('autorun')) {
            setTimeout(() => window.simulateAllRequests(), 500);
        }
    </script>
</body>
</html>
